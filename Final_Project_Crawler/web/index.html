<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="bootstrap.min.css">
        <style>
            .my-custom-scrollbar {
                position: relative;
                height: 600px;
                overflow: auto;
            }
            .table-wrapper-scroll-y {
                display: block;
            }
            .table-striped> tbody >tr:nth-child(odd){
                background-color:#d9edf7;
            }
            .table-striped>tbody>tr:nth-child(even){
                background-color: #f2dede;
            }
            .table-striped> thead>tr{
                background-color:#fff3b7;
            }
        </style>
        <script type="text/javascript">
            var airports = [];
            var results = [];
            var result;
            var validResult = true;
            var current = 0;
            function getXmlHttpObject() {
                var xmlHttp = null;
                try {// firefox, opera 8.0+, safari
                    xmlHttp = new XMLHttpRequest();
                } catch (e) {
                    try {// IE
                        xmlHttp = new ActiveXObject("Msxml2.XMLHTTP");
                    } catch (e) {
                        xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
                    }
                }
                return xmlHttp;
            }
            function sleep(milliseconds) {
                var start = new Date().getTime();
                for (var i = 0; i < 1e7; i++) {
                    if ((new Date().getTime() - start) > milliseconds) {
                        break;
                    }
                }
            }
            function addRow(tableId, cells) {
                var tableElement = document.getElementById(tableId).getElementsByTagName('tbody')[0];
                var newRow = tableElement.insertRow(tableElement.rows.length);
                var newCell;
                for (var i = 0; i < cells.length; i++) {
                    newCell = newRow.insertCell(newRow.cells.length);
                    newCell.innerHTML = cells[i];
                    if (i === (cells.length - 1)) {
                        newCell.style.color = "Grey";
                        newCell.style.fontWeight = "bold";
                    }
                }
                return newRow;
            }
            function deleteRow(tableId, rowNumber) {
                var tableElement = document.getElementById(tableId);
                if (rowNumber > 0 & rowNumber < tableElement.rows.length) {
                    tableElement.deleteRow(rowNumber);
                } else {
                    alert("Failed");
                }

            }
            function getNodeValue(nodeName, node) {
                if (node === null) {
                    return null;
                }
                if (node.tagName === nodeName) {
                    return node.firstChild.nodeValue;
                }
                var temp = node.nextSibling;
                if (temp !== null) {
                    return getNodeValue(nodeName, temp);
                }
                var child = node.childNodes;
                if (child !== null) {
                    for (var i = 0; i < child.length; i++) {
                        return getNodeValue(nodeName, child[i]);
                    }
                }
            }
            function getNodeValues(nodeName, node) {
                if (node === null) {
                    return null;
                }
                if (node.tagName === nodeName) {
                    return node.firstChild.nodeValue;
                }
                var temp = node.nextSibling;
                if (temp !== null) {
                    return getNodeValue(nodeName, temp);
                }
                var child = node.childNodes;
                if (child !== null) {
                    for (var i = 0; i < child.length; i++) {
                        return getNodeValue(nodeName, child[i]);
                    }
                }
            }
            function getElementsByXPath(xpath, parent)
            {
                let results = [];
                let query = document.evaluate(xpath, parent || document,
                        null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
                for (let i = 0, length = query.snapshotLength; i < length; ++i) {
                    results.push(query.snapshotItem(i));
                }
                return results;
            }
            function getAirports() {
                var xmlHttp = getXmlHttpObject();
                if (xmlHttp === null) {
                    alert("Your Browser not support AJAX");
                    return;
                }
                var url = "http://localhost:8080/Final_Project_WebService/airport";
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === 4 && this.status === 200) {
                        var parser = new DOMParser();
                        var xmlString = this.responseText;
                        var xmlString = xmlString.replace("<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>", "")
                        xmlDOM = parser.parseFromString(this.responseText, "application/xml");
                        //var a = getNodeValue("iataCode", xmlDOM);
                        //var airports = getElementsByXPath("//airport[descendant::iataCode[text()='AAL']]", xmlDOM);
                        var airportDoms = getElementsByXPath("//airport", xmlDOM);
                        for (var i = 0; i < airportDoms.length; i++) {
                            var airportDom = parser.parseFromString(airportDoms[i].outerHTML, "application/xml");
                            var airport = {
                                city: getElementsByXPath("//city", airportDom)[0].firstChild.nodeValue,
                                continent: getElementsByXPath("//continent", airportDom)[0].firstChild.nodeValue,
                                country: {
                                    code: getElementsByXPath("//country/code", airportDom)[0].firstChild.nodeValue,
                                    continent: getElementsByXPath("//country/continent", airportDom)[0].firstChild.nodeValue,
                                    countryTravelCost: {
                                        costCheap: getElementsByXPath("//countryTravelCost/costCheap", airportDom)[0].firstChild.nodeValue,
                                        costHigh: getElementsByXPath("//countryTravelCost/costHigh", airportDom)[0].firstChild.nodeValue,
                                        costMedium: getElementsByXPath("//countryTravelCost/costMedium", airportDom)[0].firstChild.nodeValue
                                    },
                                    name: getElementsByXPath("//country/name", airportDom)[0].firstChild.nodeValue
                                },
                                iataCode: getElementsByXPath("//iataCode", airportDom)[0].firstChild.nodeValue,
                                name: getElementsByXPath("//name", airportDom)[0].firstChild.nodeValue,
                                type: getElementsByXPath("//type", airportDom)[0].firstChild.nodeValue
                            };
                            airports.push(airport);
                        }
                        for (var i = 0; i < airports.length; i++) {
                            var cells = [];
                            cells[0] = i;
                            cells[1] = airports[i].iataCode;
                            cells[2] = airports[i].name;
                            cells[3] = airports[i].city;
                            cells[4] = airports[i].country.code;
                            cells[5] = airports[i].country.name;
                            cells[6] = airports[i].continent;
                            cells[7] = '<button type="button" id="crawl-btn-' + i + '" class="btn btn-primary" onclick="startCrawling(' + i + ')">Crawl</button>';
                            cells[8] = 'Not started';
                            addRow('tableAirport', cells);
                        }
                    }
                };
                xmlHttp.open("GET", url, true);
                xmlHttp.send(null);
            }
            async function startCrawling(i) {


                destination = airports[i].iataCode;
                var today = new Date();
                for (var j = 1; j < 14; j++) {
                    var date = new Date(today.getTime() + j * 24 * 60 * 60 * 1000);
                    var dd = String(date.getDate()).padStart(2, '0');
                    var mm = String(date.getMonth() + 1).padStart(2, '0');
                    var yyyy = date.getFullYear();
                    date = yyyy + '-' + mm + '-' + dd;
                    var url = "http://localhost:2000/https://skiplagged.com/api/search.php?from=SGN&to=" + destination + "&depart=" + date + "&return=&format=v3";
                    getResult(url);
                }
                var tableElement = document.getElementById("tableAirport").getElementsByTagName('tbody')[0];
                var cell = tableElement.rows[i].cells[8];
                cell.style.color = "Blue";
                cell.innerHTML = 'Crawling';
                var btn = document.getElementById("crawl-btn-" + i).disabled = true;

            }
            async function getResult(url) {
                var xmlHttp = getXmlHttpObject();
                if (xmlHttp === null) {
                    alert("Your Browser not support AJAX");
                    return;
                }
                xmlHttp.onreadystatechange = function () {
                    if (this.readyState === 4 && this.status === 200) {
                        var jsonObject = JSON.parse(this.responseText);
                        var flights = jsonObject.flights;
                        var prices = jsonObject.itineraries.outbound;
                        var airlines = jsonObject.airlines;
                        airlines = fixAirlines(airlines);
                        flights = fixFlights(flights, prices);
                        if (airlines.airlines.airline.length === 0 || flights.flights.flight.length === 0) {
                            validResult = false;
                            return;
                        }
                        var xmlFlights = OBJtoXML(flights);
                        var xmlAirlines = OBJtoXML(airlines);
                        result = {
                            root: {
                                xmlFlights: xmlFlights,
                                xmlAirlines: xmlAirlines}
                        };
                        result = OBJtoXML(result);
                        results.push(result);
                        insertFlights();
                    }
                };
                xmlHttp.open("GET", url, true);
                xmlHttp.send(null);
            }
            async function insertFlights() {
                var xmlHttp = getXmlHttpObject();
                if (xmlHttp === null) {
                    alert("Your Browser not support AJAX");
                    return;
                }
                xmlHttp.open("POST", "http://localhost:8080/Final_Project_WebService/flight", true);
                var xml = results.shift();
                xmlHttp.send(xml);
            }
            function fixFlights(obj, prices) {
                var flights = {
                    flights: {
                        flight: []
                    }
                };
                var price;
                for (var prop in obj) {
                    for (var item in prices) {
                        if (prop === prices[item].flight) {
                            price = prices[item].one_way_price;
                        }
                    }
                    var count = obj[prop].count - 1;
                    var flight = {
                        flight: prop,
                        departureDate: obj[prop].segments[0].departure.time.split("T")[0],
                        arrivalDate: obj[prop].segments[count].departure.time.split("T")[0],
                        duration: obj[prop].duration,
                        price: price,
                        departure: obj[prop].segments[0].departure.airport,
                        arrival: obj[prop].segments[count].departure.airport,
                        segments: obj[prop].segments

                    };
                    flights.flights.flight.push(flight);
                }
                return flights;
            }
            function fixAirlines(obj) {
                var airlines = {
                    airlines: {
                        airline: []
                    }
                };
                for (var prop in obj) {
                    var airline = {
                        code: prop,
                        name: obj[prop].name
                    };
                    airlines.airlines.airline.push(airline);
                }
                return airlines;
            }

            function OBJtoXML(obj) {
                var xml = '';
                for (var prop in obj) {
                    xml += obj[prop] instanceof Array ? '' : "<" + prop + ">\n";
                    if (obj[prop] instanceof Array) {
                        for (var array in obj[prop]) {
                            xml += "<" + prop + ">\n";
                            xml += OBJtoXML(new Object(obj[prop][array]));
                            xml += "</" + prop + ">\n";
                        }
                    } else if (typeof obj[prop] === "object") {
                        xml += OBJtoXML(new Object(obj[prop]));
                    } else {
                        xml += obj[prop] + "\n";
                    }
                    xml += obj[prop] instanceof Array ? '' : "</" + prop + ">\n";
                }
                //                var xml = xml.replace(/<\/?[0-9]{1,}>/g, '');
                return xml;
            }
            function dosomething() {
                results;
            }
            function startCrawler() {
                for (var i = 0; i < 5; i++) {
                    if (current >= airports.length)
                        break;
                    startCrawling(current);
                    current++;
                }

            }
            window.onload = getAirports;
        </script>
    </head>
    <body>
        <h3 class="text-primary text-center">Flight Crawler</h3>
        <div class="table-wrapper-scroll-y my-custom-scrollbar" style="margin: 10px">

            <table id="tableAirport" class="table table-bordered table-striped mb-0 table-hover">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">IATA code</th>
                        <th scope="col">Airport name</th>
                        <th scope="col">City</th>
                        <th scope="col">Country code</th>
                        <th scope="col">Country name</th>
                        <th scope="col">Continent</th>
                        <th scope="col"></th>
                        <th scope="col">Status</th>                        
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>

        </div>
        <!--        <div class="container py-5">
                    <div class="row">
                        <div class="col-md-10 mx-auto">
                            <form>
                                <div class="form-group row">
                                    <div class="col-sm-6">
                                        <label for="departure_date">Departure date</label>
                                        <input type="text" class="form-control" id="departure_date" placeholder="Departure date">
                                    </div>
                                    <div class="col-sm-6">
                                        <label for="arrival_date">Arrival date</label>
                                        <input type="text" class="form-control" id="arrival_date" placeholder="Arrival date">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>-->
        <div class="container">
            <div class="row">
                <div class="col text-center">
                    <button type="button" class="btn btn-primary btn-lg btn-block bg-success" onclick="startCrawler()">Crawl 5 each</button>
                </div>
            </div>
        </div>
        <script src="jquery.min.js"></script>
        <script src="bootstrap.min.js"></script>
    </body>
</html>
